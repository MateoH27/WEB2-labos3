<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML5 igra</title>
    <style>
        canvas {
            border: 1px solid black;
            background-color: ghostwhite;
        }
        html, body {
            margin: 0 !important;
            padding: 0 !important;
        }
        #time {
            top: 5%;
            left: 85%;
            font-size: 22px;
            position: fixed;
            text-align: left;
        }
        #best {
            top: 12%;
            left: 85%;
            font-size: 22px;
            position: fixed;
            text-align: left;
        }
        #lose {
            top: 50%;
            left: 50%;
            font-size: 22px;
            position: fixed;
            text-align: left;
        }
        #restart {
            top: 55%;
            left: 48%;
            font-size: 22px;
            position: fixed;
            text-align: left;
            visibility: hidden;
        }
    </style>
    <script>
        var player;
        var myGameArea = {
            canvas : document.createElement("canvas"),
            start : function() {
                this.canvas.id = "myGameCanvas";
                this.canvas.width = window.innerWidth - 8;
                this.canvas.height = window.innerHeight - 8;
                this.context = this.canvas.getContext("2d");
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.frameNo = 0;
                this.interval = setInterval(updateGameArea, 10);
                this.interval1 = setInterval(checkColision, 1);
            },
            stop : function() {
                clearInterval(this.interval);
                clearInterval(this.interval1);
            },
            clear : function() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }

        function component(width, height, color, x, y, speed_x, speed_y) {
            this.width = width;
            this.height = height;
            this.speed_x = speed_x;
            this.speed_y = speed_y; 
            this.x = x;
            this.y = y; 
            this.update = function() {
                ctx = myGameArea.context;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.shadowBlur = 10
                ctx.shadowColor = "black"
                ctx.fillStyle = color;
                ctx.lineWidth = 5
                ctx.strokeRect(0, 0, this.width, this.height)
                ctx.fillRect(0, 0, this.width, this.height);
                ctx.restore(); 
            }
            this.newPos = function() {
                this.x += this.speed_x;
                this.y += this.speed_y;
            }
        }

        // gumbi za kretanje
        var UP = false;
        var DOWN = false;
        var LEFT = false;
        var RIGHT = false;
        function myPlayer(width, height, color, x, y) {
            this.width = width;
            this.height = height;
            this.x = x;
            this.y = y; 
            this.update = function() {
                ctx = myGameArea.context;
                ctx.save();
                ctx.translate(this.x, this.y); 
                ctx.shadowBlur = 10
                ctx.shadowColor = "black"
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, this.width, this.height);
                ctx.restore(); 
            }

            //pomicanje objekta
            this.action = function() {
                if (UP) {
                    if (this.y >= 0) {
                        this.y -= 3.5
                    }
                }
                if (DOWN) {
                    if (this.y <= myGameArea.context.canvas.height - this.height) {
                        this.y += 3.5;
                    }
                }
                if (LEFT) {
                    if (this.x >= 0) {
                        this.x -= 3.5
                    } 
                }
                if (RIGHT) {
                    if (this.x <= myGameArea.context.canvas.width - this.width) {
                        this.x += 3.5
                    }
                }
            }
        }

        //event listeners
        document.onkeydown = function(e) {
            if (e.keyCode == 38) {
                UP = true;
            }
            if (e.keyCode == 40) {
                DOWN = true
            }
            if (e.keyCode == 37) {
                LEFT = true;
            }
            if (e.keyCode == 39) {
                RIGHT = true;
            }
        }

        document.onkeyup = function(e) {
            if (e.keyCode == 38) {
                UP = false;
            }
            if (e.keyCode == 40) {
                DOWN = false
            }
            if (e.keyCode == 37) {
                LEFT = false;
            }
            if (e.keyCode == 39) {
                RIGHT = false;
            }
        }

        function updateGameArea() {
            myGameArea.clear();
            player.update();
            player.action();
            for (let i = 0; i < allObjects.length; ++i) {
                allObjects[i].update();
                allObjects[i].newPos();
            }
        }

        function checkColision() {
            for (let i = 0; i < allObjects.length; ++i) {
                ul = [allObjects[i].x, allObjects[i].y]
                ur = [allObjects[i].x + allObjects[i].width, allObjects[i].y]
                bl = [allObjects[i].x, allObjects[i].y + allObjects[i].height]
                br = [allObjects[i].x + allObjects[i].width, allObjects[i].y + allObjects[i].height]
                ul_ur = [allObjects[i].x + allObjects[i].width / 2, allObjects[i].y]
                ur_br = [allObjects[i].x + allObjects[i].width, allObjects[i].y + allObjects[i].height / 2]
                bl_br = [allObjects[i].x + allObjects[i].width / 2, allObjects[i].y + allObjects[i].height]
                bl_ul = [allObjects[i].x, allObjects[i].y + allObjects[i].height / 2]
                allDots = [ul, ur, bl, br]
                if (ul[0] > player.x && ul[0] <= player.x + player.width && ul[1] > player.y && ul[1] <= player.y + player.height ||
                    ur[0] > player.x && ur[0] <= player.x + player.width && ur[1] > player.y && ur[1] <= player.y + player.height ||
                    bl[0] > player.x && bl[0] <= player.x + player.width && bl[1] > player.y && bl[1] <= player.y + player.height ||
                    br[0] > player.x && br[0] <= player.x + player.width && br[1] > player.y && br[1] <= player.y + player.height ||
                    ul_ur[0] > player.x && ul_ur[0] <= player.x + player.width && ul_ur[1] > player.y && ul_ur[1] <= player.y + player.height ||
                    ur_br[0] > player.x && ur_br[0] <= player.x + player.width && ur_br[1] > player.y && ur_br[1] <= player.y + player.height ||
                    bl_br[0] > player.x && bl_br[0] <= player.x + player.width && bl_br[1] > player.y && bl_br[1] <= player.y + player.height ||
                    bl_ul[0] > player.x && bl_ul[0] <= player.x + player.width && bl_ul[1] > player.y && bl_ul[1] <= player.y + player.height) {
                        endStopwatch();
                }
            }
        }

        var startTime; // početak timera
        function startStopwatch() {
            startTime = new Date().getTime()
            stopwatchInterval = setInterval(updateStopwatch, 1); //svaku milisekundu osvježi
        }
        function updateStopwatch() {
            var elapsedTime = new Date().getTime() - startTime; // koliko je proteklo vremena
            var milliseconds = elapsedTime % 1000;
            var seconds = Math.floor(elapsedTime / 1000) % 60;
            var minutes = Math.floor(elapsedTime / 1000 / 60) % 60;
            var displayTime = pad(minutes) + ":" + pad(seconds) + "." + milliseconds;
            document.getElementById("stopwatch").innerHTML = displayTime;
        }
        function endStopwatch() {
            var newTime = new Date().getTime() - startTime
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
            
            //zaustavi igru!
            myGameArea.stop()
            clearInterval(spawning)

            //pospremiti rezultat u localStorage
            if (!localStorage.bestTime) {
                localStorage.setItem('bestTime', newTime)
            } else {
                var oldTime = localStorage.getItem('bestTime')
                if (newTime > oldTime) {
                    localStorage.setItem('bestTime', newTime)
                }
            }
            document.getElementById("lose").innerHTML = "Game over!"
            document.getElementById("restart").style.visibility = "visible"
        }
        function pad(number) {
            return (number < 10 ? "0" : "") + number;
        }


        allObjects = []
        function startGame() {
            //pokrenuti timer
            startStopwatch();

            if (localStorage.bestTime) {
                var time = localStorage.getItem('bestTime')
                var milliseconds = time % 1000;
                var seconds = Math.floor(time / 1000) % 60;
                var minutes = Math.floor(time / 1000 / 60) % 60;
                var displayTime = pad(minutes) + ":" + pad(seconds) + "." + milliseconds;
                document.getElementById("bestTime").innerHTML = displayTime
            } else {
                document.getElementById("bestTime").innerHTML = "00:00.000"
            }

            //napraviti canvas preko cijelog platna
            myGameArea.start()

            //napraviti igrača da stoji u sredini i da se ne miče i da ne može prolaziti izvan canvasa
            player = new myPlayer(40, 40, "red", window.innerWidth / 2, window.innerHeight / 2)

            //napraviti asteroide
            spawning = setInterval(function() {
                corners = [0, 0, 0, 0]
                for(let i = 0; i < 4; ++i) {
                    corners[i] = Math.floor(Math.random() * 2) + 1;
                }
                for (let i = 0; i < corners[0]; ++i) { 
                    width = Math.floor(Math.random() * 60) + 20;
                    height = Math.floor(Math.random() * 60) + 20;
                    starting_x = -1 * Math.floor(Math.random() * 500);
                    starting_y = -1 * Math.floor(Math.random() * 500);
                    speed_x = Math.floor(Math.random() * 3) + 1;
                    speed_y = Math.floor(Math.random() * 3) + 1;
                    allObjects.push(new component(width, height, "grey", starting_x, starting_y, speed_x, speed_y)) // width, height, color, x, y, speed_x, speed_y
                }
                for (let i = 0; i < corners[1]; ++i) {
                    width = Math.floor(Math.random() * 60) + 20;
                    height = Math.floor(Math.random() * 60) + 20;
                    starting_x = -1 * Math.floor(Math.random() * 500);
                    starting_y = Math.floor(Math.random() * 500) + window.innerHeight;
                    speed_x = Math.floor(Math.random() * 3) + 1;
                    speed_y = -1 * (Math.floor(Math.random() * 3) + 1);
                    allObjects.push(new component(width, height, "grey", starting_x, starting_y, speed_x, speed_y)) // width, height, color, x, y, speed_x, speed_y
                }
                for (let i = 0; i < corners[2]; ++i) {
                    width = Math.floor(Math.random() * 60) + 20;
                    height = Math.floor(Math.random() * 60) + 20;
                    starting_x = Math.floor(Math.random() * 500) + window.innerWidth;
                    starting_y = -1 * Math.floor(Math.random() * 500);
                    speed_x = -1 * (Math.floor(Math.random() * 3) + 1);
                    speed_y = Math.floor(Math.random() * 3) + 1;
                    allObjects.push(new component(width, height, "grey", starting_x, starting_y, speed_x, speed_y)) // width, height, color, x, y, speed_x, speed_y
                }
                for (let i = 0; i < corners[3]; ++i) {
                    width = Math.floor(Math.random() * 60) + 20;
                    height = Math.floor(Math.random() * 60) + 20;
                    starting_x = Math.floor(Math.random() * 500) + window.innerWidth;
                    starting_y = Math.floor(Math.random() * 500) + window.innerHeight;
                    speed_x = -1 * (Math.floor(Math.random() * 3) + 1);
                    speed_y = -1 * (Math.floor(Math.random() * 3) + 1);
                    allObjects.push(new component(width, height, "grey", starting_x, starting_y, speed_x, speed_y)) // width, height, color, x, y, speed_x, speed_y
                }
            }, 800)
        }
        function restart() {
            location.reload()
        }
    </script>

</head>

<body onload="startGame()">
    <b>
        <div id="time">Vrijeme:
            <div id="stopwatch">00:00:00</div>
        </div>
        <div id="best">Najbolje vrijeme:
            <div id="bestTime"></div>
        </div>
        <div id="lose"></div>
        <button id="restart" onClick="restart()">Ponovno pokreni!</div>
    </b>
</body>

</html>